name: Daily SupaBase Restore-Project API call

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes
  workflow_dispatch:

# Prevent runner backlog â€” keep only the latest run
concurrency:
  group: supabase-restore
  cancel-in-progress: true

jobs:
  call_api:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Call SupaBase API
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          set -euo pipefail

          STATUS=$(curl -sS -o response.json -w "%{http_code}" \
            -X POST "https://api.supabase.com/v1/projects/kteccplzqdqymrhhyxsw/restore" \
            -H "Authorization: Bearer $API_KEY")

          echo "HTTP status: $STATUS"
          cat response.json || true

          if [ "$STATUS" = "200" ] || [ "$STATUS" = "400" ]; then
            echo "Accepted status ($STATUS). Workflow continues."
            exit 0
          else
            echo "Unexpected status ($STATUS). Failing workflow."
            exit 1
          fi
